# AI統合機能 要件定義書

## 概要

ci-helper AI統合機能は、既存のci-helperツール（Phase 1完了済み）にAI分析機能を追加するものです。この機能により、CI/CDの失敗ログを自動的にAIが分析し、根本原因の特定と修正提案を提供します。複数のAIプロバイダーに対応し、セキュアなAPIキー管理と効率的なトークン使用を実現します。

## 用語集

- **CI Helper System**: ci-helperツールのAI統合機能システム全体
- **AI Provider**: OpenAI、Anthropic、ローカルLLMなどのAIサービス提供者
- **Analyze Command**: 新しく追加される`ci-run analyze`コマンド
- **Token Management**: AIモデルのトークン制限を考慮した入力最適化
- **Streaming Response**: AIからのリアルタイム応答受信
- **Fix Suggestion**: AIが提案する具体的な修正方法
- **Interactive Mode**: AIとの対話的なデバッグセッション

## 要件

### 要件1: AI分析コマンドの実装

**ユーザーストーリー:** 開発者として、CI失敗ログをAIに分析させたい。そうすることで、エラーの根本原因と修正方法を迅速に理解できる。

#### 受け入れ基準

1. ユーザーが`ci-run analyze`を実行したとき、システムは最新のテスト実行結果をAI分析する
2. ユーザーが`--log path/to/log`を指定したとき、システムは指定されたログファイルを分析する
3. ユーザーが`--provider openai`を指定したとき、システムは指定されたAIプロバイダーを使用する
4. もしAIプロバイダーが設定されていない場合、システムは設定方法を案内するエラーメッセージを表示する

### 要件2: 複数AIプロバイダー対応

**ユーザーストーリー:** 開発者として、複数のAIプロバイダーから選択したい。そうすることで、コストや性能に応じて最適なAIサービスを使用できる。

#### 受け入れ基準

1. システムがOpenAI APIキーを検出したとき、OpenAIプロバイダーを利用可能にする
2. システムがAnthropic APIキーを検出したとき、Anthropicプロバイダーを利用可能にする
3. ユーザーが`--model gpt-4o`を指定したとき、システムは指定されたモデルを使用する
4. もし指定されたプロバイダーまたはモデルが利用できない場合、システムは利用可能な選択肢を表示する
5. システムはローカルLLM（Ollama等）への接続もサポートする

### 要件3: セキュアなAPIキー管理

**ユーザーストーリー:** 開発者として、APIキーを安全に管理したい。そうすることで、機密情報の漏洩リスクを最小化できる。

#### 受け入れ基準

1. システムがAPIキーを読み取るとき、環境変数からのみ取得する
2. もし設定ファイルにAPIキーが記載されている場合、システムは警告を表示し実行を停止する
3. ログファイルにAPIキーが含まれるとき、システムは自動的にマスクして表示する
4. AIプロバイダーとの通信時、システムは安全な接続（HTTPS）のみを使用する
5. システムはAPIキーをメモリ上でも適切に管理し、不要になったら即座に削除する

### 要件4: インテリジェントなエラー分析

**ユーザーストーリー:** 開発者として、AIによる詳細なエラー分析が欲しい。そうすることで、単なるエラーメッセージ以上の洞察を得られる。

#### 受け入れ基準

1. AIがエラーを分析するとき、システムは根本原因、影響範囲、修正優先度を含む構造化された分析を提供する
2. 複数のエラーが存在するとき、システムは関連性と修正順序を分析する
3. AIが既知のパターンを検出したとき、システムは類似事例と解決策を参照する
4. 分析結果を表示するとき、システムは技術レベルに応じて詳細度を調整する

### 要件5: 修正提案と自動適用

**ユーザーストーリー:** 開発者として、AIからの具体的な修正提案が欲しい。そうすることで、迅速に問題を解決できる。

#### 受け入れ基準

1. ユーザーが`--fix`オプションを使用したとき、システムは具体的なコード修正案を生成する
2. 修正提案を表示するとき、システムは変更前後の差分を明確に示す
3. ユーザーが修正適用を承認したとき、システムは該当ファイルを自動的に更新する
4. もし修正が複数ファイルに及ぶ場合、システムは各ファイルごとに個別の承認を求める
5. 修正適用前に、システムは自動的にバックアップを作成する

### 要件6: 対話的AIデバッグモード

**ユーザーストーリー:** 開発者として、AIと対話しながらデバッグしたい。そうすることで、複雑な問題を段階的に解決できる。

#### 受け入れ基準

1. ユーザーが`--interactive`を指定したとき、システムは対話的なセッションを開始する
2. 対話中にユーザーが追加質問をしたとき、システムは文脈を保持して回答する
3. ユーザーが`/help`を入力したとき、システムは利用可能なコマンドを表示する
4. ユーザーが`/exit`を入力したとき、システムは対話セッションを終了する
5. 対話セッション中、システムはトークン使用量をリアルタイムで表示する

### 要件7: ストリーミングレスポンス対応

**ユーザーストーリー:** 開発者として、AIの応答をリアルタイムで見たい。そうすることで、長い分析でも進捗を確認できる。

#### 受け入れ基準

1. AIプロバイダーがストリーミングをサポートするとき、システムはリアルタイムで応答を表示する
2. ストリーミング中にユーザーがCtrl+Cを押したとき、システムは優雅に中断し部分的な結果を保存する
3. ネットワークエラーが発生したとき、システムは自動的にリトライを実行する
4. ストリーミング表示中、システムは適切なプログレス表示を提供する

### 要件8: コスト管理と使用統計

**ユーザーストーリー:** 開発者として、AI使用コストを把握したい。そうすることで、予算内でサービスを利用できる。

#### 受け入れ基準

1. AI分析実行後、システムは使用トークン数と推定コストを表示する
2. ユーザーが`ci-run analyze --stats`を実行したとき、システムは過去の使用統計を表示する
3. 月間使用量が設定された制限に近づいたとき、システムは警告を表示する
4. 高コストな分析を実行する前に、システムは推定コストを表示し確認を求める

### 要件9: AIレスポンスキャッシュ

**ユーザーストーリー:** 開発者として、同じエラーの再分析時にコストを節約したい。そうすることで、効率的にAIサービスを利用できる。

#### 受け入れ基準

1. 同一のログ内容を分析するとき、システムはキャッシュされた結果を使用する
2. キャッシュが古くなったとき、システムは自動的に新しい分析を実行する
3. ユーザーが`--no-cache`を指定したとき、システムはキャッシュを無視して新しい分析を実行する
4. キャッシュサイズが制限を超えたとき、システムは最も古いエントリを自動削除する

### 要件10: プロンプトテンプレート管理

**ユーザーストーリー:** 開発者として、AI分析の品質を向上させたい。そうすることで、より正確で有用な分析結果を得られる。

#### 受け入れ基準

1. システムがエラータイプを検出したとき、適切な専用プロンプトテンプレートを使用する
2. ユーザーが`--prompt "カスタム指示"`を指定したとき、システムはカスタムプロンプトを追加する
3. プロンプトテンプレートを更新するとき、システムは設定ファイルから読み込む
4. 新しいエラーパターンが検出されたとき、システムは汎用プロンプトで対応する

### 要件11: エラーハンドリングと復旧

**ユーザーストーリー:** 開発者として、AI統合でエラーが発生しても適切に処理されることを期待する。そうすることで、安定したツール利用ができる。

#### 受け入れ基準

1. もしAPIキーが無効な場合、システムは明確なエラーメッセージと設定方法を表示する
2. もしAPI制限に達した場合、システムは制限リセット時刻と代替手段を提案する
3. もしネットワークエラーが発生した場合、システムは自動リトライと手動再実行オプションを提供する
4. もしAI分析が失敗した場合、システムは従来のログ表示にフォールバックする
5. タイムアウトが発生したとき、システムは部分的な結果を保存し後で継続できるようにする

### 要件12: 設定とカスタマイゼーション

**ユーザーストーリー:** 開発者として、AI統合機能をプロジェクトに合わせてカスタマイズしたい。そうすることで、最適な分析結果を得られる。

#### 受け入れ基準

1. 設定ファイルにAI設定セクションが存在するとき、システムはそれらの設定を読み込む
2. 環境変数でAI設定が指定されているとき、システムは設定ファイルより優先する
3. プロジェクト固有のプロンプトテンプレートが存在するとき、システムはそれを使用する
4. もし設定が競合している場合、システムは明確な優先順位に従って解決する

### 要件13: ファイル所有権とアクセス権限の保持

**ユーザーストーリー:** 開発者として、ci-helperを実行した後もファイルの所有権が変更されないことを期待する。そうすることで、プロジェクトファイルへの正常なアクセスを維持できる。

#### 受け入れ基準

1. ci-helperがDockerコンテナ内でactを実行するとき、システムはホストのファイル所有権を保持する
2. もしファイルの所有権がdockerユーザーに変更された場合、システムは自動的に元の所有者に復元する
3. ユーザーが`ci-run test`を実行した後、システムはプロジェクトディレクトリ内のファイル所有権を確認し、必要に応じて修正する
4. システムは実行前後でファイル所有権の変更を検出し、警告を表示する
5. もしファイル所有権の修正に失敗した場合、システムは明確なエラーメッセージと手動修正方法を表示する
