# 要件定義書

## 概要

ci-helperプロジェクトは、`act`を使用したローカルCI/CDパイプライン検証とAI統合機能を提供する包括的なCLIツールです。このツールは、ローカルテスト、インテリジェントなログ解析、AI駆動のエラー解決を提供することで、従来のCI/CDフィードバックループの非効率性を解決します。システムは3つのフェーズで実装されます：フェーズ1（コアMVP）、フェーズ2（拡張機能）、フェーズ3（AI統合）。

## 要件

### 要件1: CLIフレームワークとコマンド構造

**ユーザーストーリー:** 開発者として、統一されたマルチコマンドCLIインターフェースを使いたい。そうすることで、一貫したコマンド構造を通じてci-helperのすべての機能にアクセスできる。

#### 受け入れ基準

1. ユーザーが`ci-run --help`を実行したとき、システムは利用可能なすべてのコマンドと説明を表示する
2. ユーザーが任意のコマンドで`--help`を実行したとき、システムはコマンド固有のオプションと使用例を表示する
3. システムが`uv tool install`でインストールされたとき、`ci-run`コマンドがグローバルに利用可能になる
4. もしコマンドが現在のフェーズで利用できない場合、システムは機能が将来のリリースで提供されることを示す適切なメッセージを表示する

### 要件2: 環境セットアップと検証

**ユーザーストーリー:** 開発者として、環境セットアップを検証したい。そうすることで、CIテストを実行する前にすべての依存関係が適切に設定されていることを確認できる。

#### 受け入れ基準

1. ユーザーが`ci-run init`を実行したとき、システムは設定ファイルテンプレート（.actrc、ci-helper.toml、.env.example）を生成する
2. ユーザーが`ci-run doctor`を実行したとき、システムはactのインストール、Dockerデーモンの状態、.github/workflowsディレクトリの存在をチェックする
3. もし依存関係が不足している場合、システムは明確なインストール手順とセットアップガイダンスを提供する
4. 環境検証が成功したとき、システムは次のステップと共に成功メッセージを表示する

### 要件3: ローカルCI実行とログ管理

**ユーザーストーリー:** 開発者として、actを使用してGitHub Actionsワークフローをローカルで実行したい。そうすることで、GitHubにプッシュすることなく変更をテストできる。

#### 受け入れ基準

1. ユーザーが`ci-run test`を実行したとき、システムは設定されたワークフローでactを実行し、すべての出力をキャプチャする
2. ユーザーが`--workflow test.yml`を指定したとき、システムは指定されたワークフローファイルのみを実行する
3. ユーザーが`--verbose`フラグを使用したとき、システムは詳細な実行情報を表示する
4. 実行が完了したとき、システムはデフォルトで`.ci-helper/logs/act_TIMESTAMP.log`にログを保存する
5. もしユーザーが`--no-save`を指定した場合、システムはログをディスクに保存しない
6. ユーザーが`ci-run logs`を実行したとき、システムはタイムスタンプ付きの過去の実行ログのリストを表示する

### 要件4: 失敗検出と抽出

**ユーザーストーリー:** 開発者として、CIログから失敗情報を自動抽出したい。そうすることで、何が問題だったかを迅速に特定し理解できる。

#### 受け入れ基準

1. act実行に失敗が含まれているとき、システムはエラーメッセージ、スタックトレース、アサーション失敗を抽出する
2. 失敗を抽出するとき、システムは各エラーの前後に設定可能なコンテキスト行を含める
3. 複数のワークフローが失敗したとき、システムはワークフローとジョブごとに失敗を整理する
4. もし失敗が検出されない場合、システムは要約統計と共に成功実行を報告する

### 要件5: 出力フォーマットとトークン管理

**ユーザーストーリー:** 開発者として、AI消費用にフォーマットされた失敗情報が欲しい。そうすることで、デバッグヘルプのためにAIアシスタントとコンテキストを簡単に共有できる。

#### 受け入れ基準

1. ユーザーが`--format markdown`を指定したとき、システムはコードブロックと明確なセクションを持つ構造化されたMarkdownを出力する
2. ユーザーが`--format json`を指定したとき、システムは機械可読なJSON形式を出力する
3. 出力をフォーマットするとき、システムはAIモデル用の推定トークン使用量をカウントし表示する
4. もしトークン数がモデル制限を超える場合、システはユーザーに警告し圧縮オプションを提案する
5. 出力を表示するとき、システムは重要なエラーをハイライトし明確なセクション構成を提供する

### 要件6: ログ解析と比較

**ユーザーストーリー:** 開発者として、現在のテスト結果を過去の実行と比較したい。そうすることで、進捗を追跡し回帰を特定できる。

#### 受け入れ基準

1. ユーザーが`ci-run test --diff`を実行したとき、システムは最新の過去の実行と結果を比較する
2. 差分を表示するとき、システムは変更を新しいエラー、解決されたエラー、または変更なしに分類する
3. ユーザーが`ci-run test --dry-run --log path/to/log`を実行したとき、システムはactを実行せずに既存のログを解析する
4. もし過去の実行が存在しない場合、システムはユーザーに通知し通常の実行を続行する

### 要件7: 設定管理

**ユーザーストーリー:** 開発者として、柔軟な設定オプションが欲しい。そうすることで、プロジェクトの特定のニーズに合わせてci-helperの動作をカスタマイズできる。

#### 受け入れ基準

1. 設定ファイルが存在するとき、システムはプロジェクトルートのci-helper.tomlから設定を読み込む
2. 環境変数が設定されているとき、システムはそれらを使用して設定ファイルの値を上書きする
3. ユーザーがコマンドラインオプションを指定したとき、それらは設定ファイルと環境変数より優先される
4. もし設定が無効な場合、システムは修正ガイダンスと共に明確なエラーメッセージを表示する

### 要件8: エラーハンドリングと復旧

**ユーザーストーリー:** 開発者として、包括的なエラーハンドリングが欲しい。そうすることで、実行中に問題が発生したときに明確なガイダンスを受け取れる。

#### 受け入れ基準

1. もしactがインストールされていない場合、システムはユーザーのオペレーティングシステム用のインストール手順を表示する
2. もしDockerデーモンが実行されていない場合、システムはDockerを開始する手順を提供する
3. もしワークフローファイルが見つからない場合、システムは.github/workflowsディレクトリをチェックすることを提案する
4. タイムアウトが発生したとき、システムは優雅なキャンセルを許可し部分的な結果を提供する
5. もしディスク容量が不十分な場合、システムはユーザーに警告しクリーンアップオプションを提案する

### 要件9: キャッシュとクリーンアップ管理

**ユーザーストーリー:** 開発者として、効率的なキャッシュ管理が欲しい。そうすることで、パフォーマンス利益を維持しながらディスク使用量を制御できる。

#### 受け入れ基準

1. ユーザーが`ci-run clean`を実行したとき、システムはキャッシュされたログと一時ファイルを削除する
2. ユーザーが`--logs-only`を指定したとき、システムは他のキャッシュを保持しながらログファイルのみを削除する
3. キャッシュサイズが設定された制限を超えたとき、システムは自動的に最も古いエントリを削除する
4. もしユーザーが`ci-run clean --all`を実行した場合、システムはci-helperが生成したすべてのファイルを削除し初期状態にリセットする

### 要件10: セキュリティとシークレット管理

**ユーザーストーリー:** 開発者として、APIキーとシークレットの安全な取り扱いが欲しい。そうすることで、機密情報がログや設定ファイルに露出されることがない。

#### 受け入れ基準

1. APIキーが必要なとき、システムは環境変数からのみそれらを読み取る
2. ログを処理するとき、システムは保存または表示する前に検出されたシークレットパターンをフィルタリングする
3. フォーマットされた出力を共有するとき、システムは潜在的に機密な情報をサニタイズする
4. もし設定ファイルにシークレットが見つかった場合、システムはユーザーに警告し続行を拒否する
5. actがシークレットを必要とするとき、システムはログに記録することなく環境変数を通じて安全にそれらを渡す
