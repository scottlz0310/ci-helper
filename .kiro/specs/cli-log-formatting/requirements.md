# 要件定義書

## 概要

本仕様書は、CI-HelperのCLIメニューシステムにログ整形機能を追加するための要件を定義します。この機能により、ユーザーは対話的メニューから直接ログを様々な形式（AI消費用、人間可読、JSON等）に整形できるようになり、CI失敗ログの分析と共有が効率化されます。

## 用語集

- **ログ整形機能**: 実行ログを指定された形式（Markdown、JSON、プレーンテキスト等）に変換する機能
- **AI消費用フォーマット**: AI分析に最適化されたMarkdown形式で、コンテキスト情報と構造化されたエラー情報を含む
- **人間可読フォーマット**: 開発者が読みやすいように色付けとセクション分けされた形式
- **CLIメニューシステム**: Rich ライブラリを使用した対話的なメニューインターフェース
- **コマンド指定実行方式**: CLIコマンドライン引数を使用した非対話的な実行方式
- **メニュー選択方式**: 対話的メニューを使用したユーザーフレンドリーな実行方式
- **ログ管理サブメニュー**: ログ関連機能をまとめたサブメニュー
- **整形オプション**: 出力形式、ファイル保存、フィルタリング等の設定可能なパラメータ

## 要件

### 要件1

**ユーザーストーリー:** CI-Helperを使用する開発者として、CLIメニューからログ整形機能にアクセスすることで、コマンドライン引数を覚えることなく直感的にログを整形したい。

#### 受け入れ基準

1. WHEN ログ管理サブメニューを表示する時、THE CLIメニューシステム SHALL ログ整形オプションを表示する
2. THE ログ管理サブメニュー SHALL 「ログ整形」メニュー項目を含む
3. WHEN ログ整形メニュー項目を選択する時、THE CLIメニューシステム SHALL ログ整形サブメニューを表示する
4. THE ログ整形サブメニュー SHALL 複数の整形オプションを提供する
5. THE CLIメニューシステム SHALL 各整形オプションに説明文を表示する

### 要件2

**ユーザーストーリー:** 開発者として、AI分析用に最適化されたログ形式を選択することで、AI分析の精度を向上させたい。

#### 受け入れ基準

1. THE ログ整形サブメニュー SHALL 「AI分析用フォーマット」オプションを提供する
2. WHEN AI分析用フォーマットを選択する時、THE ログ整形機能 SHALL コンテキスト強化されたMarkdown形式で出力する
3. THE AI分析用フォーマット SHALL エラーの優先度付けを含む
4. THE AI分析用フォーマット SHALL コードコンテキストと行番号を含む
5. THE AI分析用フォーマット SHALL 修正提案セクションを含む

### 要件3

**ユーザーストーリー:** 開発者として、人間が読みやすい形式でログを整形することで、チームメンバーとの問題共有を効率化したい。

#### 受け入れ基準

1. THE ログ整形サブメニュー SHALL 「人間可読フォーマット」オプションを提供する
2. WHEN 人間可読フォーマットを選択する時、THE ログ整形機能 SHALL 色付けされた構造化出力を生成する
3. THE 人間可読フォーマット SHALL セクション分けされたレイアウトを使用する
4. THE 人間可読フォーマット SHALL 重要なエラー情報をハイライト表示する
5. THE 人間可読フォーマット SHALL 実行時間とステータス情報を含む

### 要件4

**ユーザーストーリー:** 開発者として、JSON形式でログを出力することで、他のツールやスクリプトでログデータを処理したい。

#### 受け入れ基準

1. THE ログ整形サブメニュー SHALL 「JSON形式」オプションを提供する
2. WHEN JSON形式を選択する時、THE ログ整形機能 SHALL 構造化されたJSONデータを出力する
3. THE JSON出力 SHALL 実行結果、エラー情報、タイムスタンプを含む
4. THE JSON出力 SHALL 有効なJSON形式である
5. THE JSON出力 SHALL プログラム的に解析可能な構造を持つ

### 要件5

**ユーザーストーリー:** 開発者として、整形されたログをファイルに保存することで、後で参照したり他の人と共有したりしたい。

#### 受け入れ基準

1. WHEN ログ整形オプションを選択する時、THE CLIメニューシステム SHALL ファイル保存オプションを提供する
2. THE ログ整形機能 SHALL ユーザー指定のファイルパスに出力を保存する
3. THE ログ整形機能 SHALL デフォルトのファイル名を提案する
4. IF ファイルが既に存在する場合、THEN THE ログ整形機能 SHALL 上書き確認を求める
5. THE ログ整形機能 SHALL 保存成功時に確認メッセージを表示する

### 要件6

**ユーザーストーリー:** 開発者として、特定のログファイルを選択して整形することで、過去の実行結果も分析できるようにしたい。

#### 受け入れ基準

1. THE ログ整形サブメニュー SHALL 「最新ログ整形」と「特定ログ整形」オプションを提供する
2. WHEN 特定ログ整形を選択する時、THE CLIメニューシステム SHALL ログファイル選択プロンプトを表示する
3. THE ログファイル選択 SHALL 利用可能なログファイルの一覧を表示する
4. THE ログファイル選択 SHALL カスタムファイルパス入力を許可する
5. IF 指定されたログファイルが存在しない場合、THEN THE ログ整形機能 SHALL エラーメッセージを表示する

### 要件7

**ユーザーストーリー:** 開発者として、整形オプションをカスタマイズすることで、特定のニーズに合わせた出力を得たい。

#### 受け入れ基準

1. THE ログ整形サブメニュー SHALL 「カスタム整形」オプションを提供する
2. WHEN カスタム整形を選択する時、THE CLIメニューシステム SHALL 整形パラメータ設定画面を表示する
3. THE 整形パラメータ設定 SHALL 出力形式選択を含む
4. THE 整形パラメータ設定 SHALL フィルタリングオプションを含む
5. THE 整形パラメータ設定 SHALL 詳細レベル設定を含む

### 要件8

**ユーザーストーリー:** 開発者として、コマンドライン引数を使用してログ整形を実行することで、スクリプトや自動化ツールから非対話的にログ整形機能を利用したい。

#### 受け入れ基準

1. THE CI-Helper CLI SHALL `format-logs` コマンドを提供する
2. THE `format-logs` コマンド SHALL `--format` オプションで出力形式を指定可能にする
3. THE `format-logs` コマンド SHALL `--input` オプションでログファイルを指定可能にする
4. THE `format-logs` コマンド SHALL `--output` オプションで出力ファイルを指定可能にする
5. WHERE オプションが指定されない場合、THE `format-logs` コマンド SHALL デフォルト値を使用する

### 要件9

**ユーザーストーリー:** AI分析ツールの開発者として、コマンドライン経由でAI最適化フォーマットを取得することで、CI/CDパイプラインに組み込んだ自動分析を実現したい。

#### 受け入れ基準

1. THE `format-logs` コマンド SHALL `--format ai` オプションでAI消費用フォーマットを出力する
2. THE `format-logs` コマンド SHALL `--format human` オプションで人間可読フォーマットを出力する
3. THE `format-logs` コマンド SHALL `--format json` オプションでJSON形式を出力する
4. THE `format-logs` コマンド SHALL 標準出力への出力をサポートする
5. THE `format-logs` コマンド SHALL 終了コードで処理結果を示す

### 要件10

**ユーザーストーリー:** 開発者として、整形処理の進行状況を確認することで、大きなログファイルの処理中も安心して待機したい。

#### 受け入れ基準

1. WHEN ログ整形処理を開始する時、THE CLIシステム SHALL 処理開始メッセージを表示する
2. WHERE ログファイルが大きい場合、THE ログ整形機能 SHALL 進行状況インジケータを表示する
3. THE ログ整形機能 SHALL 処理完了時に成功メッセージを表示する
4. IF 整形処理でエラーが発生した場合、THEN THE ログ整形機能 SHALL 詳細なエラーメッセージを表示する
5. THE CLIメニューシステム SHALL 処理完了後にメニューに戻るオプションを提供する

### 要件11

**ユーザーストーリー:** 開発者として、両方の実行方式（メニューとコマンド）で同じ機能にアクセスできることで、状況に応じて最適な方法を選択したい。

#### 受け入れ基準

1. THE ログ整形機能 SHALL メニュー選択方式とコマンド指定実行方式の両方をサポートする
2. THE 両方の実行方式 SHALL 同じ整形エンジンを使用する
3. THE 両方の実行方式 SHALL 同じ出力品質を提供する
4. THE コマンド指定実行方式 SHALL バッチ処理とスクリプト統合を可能にする
5. THE メニュー選択方式 SHALL 対話的な探索と学習を可能にする
