# 実装計画

- [x] 1. フォーマッターアーキテクチャの構築
  - 基底フォーマッタークラス `BaseLogFormatter` を作成
  - フォーマッターマネージャー `FormatterManager` を実装
  - 既存の `AIFormatter` との統合インターフェースを設計
  - _要件: 1.1, 2.1, 3.1, 4.1_

- [x] 2. AI消費用フォーマッターの実装
  - `AIContextFormatter` クラスを作成してコンテキスト強化機能を実装
  - 失敗の優先度付けロジック `_prioritize_failures` を実装
  - クリティカル失敗の詳細整形機能 `_format_critical_failures` を実装
  - 修正提案セクション `_format_suggested_fixes` を実装
  - 関連ファイル情報 `_format_related_files` を実装
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5_

- [x] 3. 人間可読フォーマッターの実装
  - `HumanReadableFormatter` クラスを作成
  - Rich ライブラリを使用した色付け出力機能を実装
  - セクション分けされたレイアウト機能を実装
  - 重要なエラー情報のハイライト表示機能を実装
  - 実行時間とステータス情報の表示機能を実装
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 4. JSON専用フォーマッターの実装
  - `JSONFormatter` クラスを作成
  - 構造化されたJSONデータ出力機能を実装
  - 実行結果、エラー情報、タイムスタンプを含むJSON構造を設計
  - 有効なJSON形式の検証機能を実装
  - プログラム的に解析可能な構造を確保
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5_

- [x] 5. ログ管理サブメニューの拡張
  - 既存の `_build_logs_submenu` メソッドにログ整形オプションを追加
  - ログ整形サブメニュー `_build_log_formatting_submenu` を実装
  - AI分析用、人間可読、JSON形式の各メニュー項目を追加
  - カスタム整形メニュー項目を追加
  - メニュー項目の説明文を日本語で実装
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 6. ログファイル選択機能の実装
  - 最新ログ整形と特定ログ整形のオプションを実装
  - ログファイル選択プロンプト機能を実装
  - 利用可能なログファイル一覧表示機能を実装
  - カスタムファイルパス入力機能を実装
  - ファイル存在チェックとエラーメッセージ表示機能を実装
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5_

- [x] 7. ファイル保存機能の実装
  - ファイル保存オプションの提供機能を実装
  - ユーザー指定ファイルパスへの出力保存機能を実装
  - デフォルトファイル名の提案機能を実装
  - ファイル上書き確認機能を実装
  - 保存成功時の確認メッセージ表示機能を実装
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5_

- [x] 8. カスタム整形機能の実装
  - カスタム整形オプションの提供機能を実装
  - 整形パラメータ設定画面を実装
  - 出力形式選択機能を実装
  - フィルタリングオプション機能を実装
  - 詳細レベル設定機能を実装
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [x] 9. format-logs コマンドの実装
  - 新規コマンド `format_logs.py` を作成
  - `--format` オプションで出力形式指定機能を実装
  - `--input` オプションでログファイル指定機能を実装
  - `--output` オプションで出力ファイル指定機能を実装
  - デフォルト値の処理機能を実装
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 10. コマンドライン統合の実装
  - AI最適化フォーマット `--format ai` オプションを実装
  - 人間可読フォーマット `--format human` オプションを実装
  - JSON形式 `--format json` オプションを実装
  - 標準出力への出力サポートを実装
  - 終了コードによる処理結果表示機能を実装
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 11. 進行状況表示機能の実装
  - 処理開始メッセージ表示機能を実装
  - 大きなログファイル用の進行状況インジケータを実装
  - 処理完了時の成功メッセージ表示機能を実装
  - エラー発生時の詳細エラーメッセージ表示機能を実装
  - メニューに戻るオプション機能を実装
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5_

- [x] 12. 統合テストとバリデーション
  - メニュー選択方式とコマンド指定実行方式の統合テストを実装
  - 同じ整形エンジンの使用確認テストを実装
  - 同じ出力品質の確認テストを実装
  - バッチ処理とスクリプト統合のテストを実装
  - 対話的探索機能のテストを実装
  - _要件: 11.1, 11.2, 11.3, 11.4, 11.5_

- [x] 13. セキュリティ機能の統合
  - 既存の `SecurityValidator` との統合を実装
  - シークレットサニタイズ機能の継承を実装
  - 出力ファイルのパス検証機能を実装
  - 上位ディレクトリへの書き込み防止機能を実装

- [x] 14. パフォーマンス最適化
  - 大きなログファイルのストリーミング処理を実装
  - メモリ使用量制限機能を実装
  - フォーマット結果のキャッシュ機能を実装
  - 同一ログファイルの重複処理回避機能を実装

- [x] 15. エラーハンドリングの強化
  - ファイル関連エラーの処理機能を実装
  - フォーマット関連エラーの処理機能を実装
  - ユーザー入力エラーの処理機能を実装
  - 適切なエラーメッセージの日本語化を実装

## 実装完了

すべてのタスクが完了しました。CLI ログ整形機能は以下の要素で構成されています：

### 実装済み機能

- **フォーマッターアーキテクチャ**: 基底クラス、マネージャー、各種フォーマッター
- **メニュー統合**: ログ管理サブメニューからの対話的アクセス
- **コマンドライン統合**: `ci-run format-logs` コマンドでの非対話的実行
- **セキュリティ**: シークレットサニタイズとファイルパス検証
- **パフォーマンス**: ストリーミング処理とキャッシュ機能
- **エラーハンドリング**: 包括的なエラー処理と日本語メッセージ
- **テスト**: 統合テストと単体テストの完全なカバレッジ

### 利用可能なフォーマット

- **AI形式**: AI分析に最適化されたMarkdown（コンテキスト強化、優先度付け）
- **人間可読形式**: Rich ライブラリによる色付け構造化出力
- **JSON形式**: プログラム処理用の構造化データ

### 実行方式

- **メニュー選択**: 対話的なメニューシステムからの実行
- **コマンドライン**: スクリプト・自動化対応の非対話的実行

この機能により、開発者はCI失敗ログを効率的に整形・分析し、AI分析や他のツールとの連携が可能になります。
